# fileBuilder

fileBuilder — сборщик JS-файлов ([форк](https://github.com/Kolyaj/Jossy)) в один или несколько модулей.
При правильном использовании позволяет не только легко собирать модули,
но и также легко пересобирать их при изменении принципов сборки.

## Синтаксис и возможности

### Подключение файлов

Включить содержимое внешнего файла в текущий можно директивой `#include ...`, `require('...');` или `@import url("...");`

```js
//#include file.js
```

Путь к файлу указывается относительно расположения текущего файла.
Технически, вместо строки с директивой просто вставляется содержимое указанного файла.
Однако, если указанный файл уже подключен в текущем модуле ранее, то повторно он включен не будет. Например, файл f1.js

```js
alert(1);
```

Файл f2.js

```js
//#include f1.js
alert(2);
```

И файл f3.js

```js
//#include f1.js
//#include f2.js
```

Если скормить fileBuilder файл f3.js, то на выходе получим

```js
alert(1);
alert(2);
```

### Исключение файлов из сборки

Директива `#without` указывает fileBuilder исключить из сборки все файлы,
которые используются в указанном (включая указанный, разумеется).

Пример. В проекте есть несколько десятков виджетов.
Код каждого виджета лежит в отдельном файле.
В каждом виджете указаны его зависимости с помощью директивы `#include`.
Какие-то виджеты используются на большинстве страниц, и при сборке логично их код вынести в отдельный файл common.js.
Выбираем часто используемые виджеты, создаём файл common.js и пишем туда

```js
//#include widget1.js
//#include widget2.js
//#include widget3.js
```

На одной из страниц используется виджет, достаточно объёмный, чтобы не включать его в common.js,
назовём его big-widget. В файле big-widget.js указаны его зависимости, среди которых,
разумеется, много тех, которые уже есть в common.js. Если мы просто соберём файл big-widget.js,
то получим много продублированного кода. Поэтому рядом с common.js создаём файл feature.js с содержимым

```js
//#without common.js
//#include big-widget.js
```

Теперь код, попавший в common.js, не попадёт в feature.js.
Главное не забыть подключить на страницу не только feature.js, но и common.js.

### Условная сборка

В процессе сборки можно определять булевые флаги, в зависимости от которых выводить или не выводить строки кода.

```js
//#set flag

//#if flag
alert('flag');
//#endif

//#if not flag
alert('not flag');
//#endif

//#unset flag
```

Флаги глобальные. Указать их можно не только в коде директивами `#set` и `#unset`,
но при запуске сборщика (о запуске сборщика ниже).

Например, файл file.js

```js
//#if ie
alert('IE only');
//#endif
```

Файл common.js

```js
//#include file.js
```

И файл common-ie.js

```js
//#set ie
//#include file.js
```

Точно также можно создать флаг debug и писать отладочные строки только внутри `//#if debug ... //#endif`,
тогда отладочный код никогда не попадёт на боевые сервера.

### Подключение кусков файлов

Эта фича узкоспециализирована, но очень полезна при разработке библиотек и фреймворков.
Например, в нашей библиотеке есть файл String.js, содержащий несколько десятков функций для работы со строками.
Выделять каждую функцию в отдельный файл как-то неправильно,
но и подключать потом несколько сотен строк кода ради одной функции тоже не хочется.
В результате, обычно всё заканчивается копипастой.
В случае с fileBuilder файл String.js размечается на области.
Имена у областей могут быть произвольными, но лучше, чтобы они совпадали с именами функций.

```js
var String = {};

//#label truncate
String.truncate = function() {

};
//#endlabel truncate

//#label escapeHTML
String.escapeHTML = function() {

};
//#endlabel escapeHTML
```

Теперь, если нам нужна только функция `escapeHTML`, то при подлючении файла String.js пишем

```js
//#include String.js::escapeHTML
```

В результате в сборку попадёт только

```js
var String = {};

String.escapeHTML = function() {

};
```

Если нужно подключить несколько областей, указываем несколько

```js
//#include String.js::trim::truncate
```

Если нужно подключить всё, кроме размеченных областей (например, нам нужен только namespace String), то

```js
//#include String.js::
```

Если же какой-то области необходима другая область из текущего файла, то используем `#include` без указания файла.

```js
//#label truncate
//#include ::trim
String.truncate = function() {};
//#endlabel truncate
```

Обратите внимание, что размеченные таким образом области файла в собранном коде могут поменять порядок и
между ними может появиться другой код.

Например,

```js
//#include String.js::escapeHTML
alert(1);
//#include String.js::truncate
```

После сборки получим

```js
var String = {};

String.escapeHTML = function() {

};

alert(1);

String.truncate = function() {

};
```

Поэтому использовать `#label` внутри функций и выражений нельзя, на выходе получим поломанный JavaScript.

Кроме этого, `#without` тоже смотрит на эти области. Поэтому, например, `escapeHTML` может попасть в common.js,
а `truncate` — в feature.js.

## Использование

### Сборка из командной строки

```js
fileBuilder file.js debug ie
```

Где file.js — имя файла, debug и ie — флаги, которые можно использовать в директиве `#if`.
Результат сборки выводится в output, поэтому если хочется сразу сохранить его в файл

```js
fileBuilder file.js debug ie > _file.js
```

### Использование сборщика из NodeJS

```js
var fileBuilder = require('fileBuilder');
fileBuilder.compile('String.js', ['escapeHTML'], {ie: true}, function(err, result) {
	if (err) {
		trhow err;
	}
	console.log(result);
});
```

## Лицензия

The MIT License (MIT)

Copyright (c) 2014 Андрей Кобец (Kobezzza) <<kobezzza@mail.ru>>

Данная лицензия разрешает лицам, получившим копию данного программного обеспечения и
сопутствующей документации (в дальнейшем именуемыми «Программное Обеспечение»),
безвозмездно использовать Программное Обеспечение без ограничений, включая неограниченное право на использование,
копирование, изменение, добавление, публикацию, распространение, сублицензирование и/или
продажу копий Программного Обеспечения, также как и лицам, которым предоставляется данное
Программное Обеспечение, при соблюдении следующих условий:

Указанное выше уведомление об авторском праве и данные условия должны быть включены во все копии или
значимые части данного Программного Обеспечения.

ДАННОЕ ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ ПРЕДОСТАВЛЯЕТСЯ «КАК ЕСТЬ», БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ, ЯВНО ВЫРАЖЕННЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ,
ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ ГАРАНТИЯМИ ТОВАРНОЙ ПРИГОДНОСТИ, СООТВЕТСТВИЯ ПО ЕГО КОНКРЕТНОМУ НАЗНАЧЕНИЮ И
ОТСУТСТВИЯ НАРУШЕНИЙ ПРАВ. НИ В КАКОМ СЛУЧАЕ АВТОРЫ ИЛИ ПРАВООБЛАДАТЕЛИ НЕ НЕСУТ ОТВЕТСТВЕННОСТИ ПО ИСКАМ О
ВОЗМЕЩЕНИИ УЩЕРБА, УБЫТКОВ ИЛИ ДРУГИХ ТРЕБОВАНИЙ ПО ДЕЙСТВУЮЩИМ КОНТРАКТАМ, ДЕЛИКТАМ ИЛИ ИНОМУ, ВОЗНИКШИМ ИЗ,
ИМЕЮЩИМ ПРИЧИНОЙ ИЛИ СВЯЗАННЫМ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ ИЛИ ИСПОЛЬЗОВАНИЕМ ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ ИЛИ
ИНЫМИ ДЕЙСТВИЯМИ С ПРОГРАММНЫМ ОБЕСПЕЧЕНИЕМ.